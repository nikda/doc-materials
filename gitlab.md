Автоматический деплой файлов из GitLab в Camunda

Как это работает?

Файлы для камунды лежат в гит-репозитории.
При коммите, добавляющем или изменяющем один или несколько файлов, срабатывает веб-хук из Гитлаба, отправляющий POST-запрос на наш сервис (mp-sys-bpm-manager).
В запросе содержатся, помимо прочего, имена добавленных/измененных файлов. Эти файлы mp-sys-bpm-manager запрашивает у отдельного конфиг-сервера (mp-sys-bpm-config), который получает их из гита и обновляет при запросе.
Получив файлы, mp-sys-bpm-manager деплоит их в камунду, используя feign-клиенты из mp-sys-bpm-api.
Таким образом, чтобы задеплоить файл в камунду, нужно просто закоммитить его в репозиторий.


Как развернуть это локально?

1) Запускаем локальный GitLab. Например, через докер:

docker run -d --name gitlab -p 10443:443 -p 10080:80 -p 10022:22 gitlab/gitlab-ce:latest

Заходим на localhost:10080, регистрируемся, создаем новый репозиторий.



2) Заходим в гитлаб под админом (логин root, пароль устанавливается при первом заходе на гитлаб).

Идем в Admin Area (гаечный ключ вверху посередине).

Settings → Network → Outbound requests → ставим галку на Allow requests to the local network from hooks and services

Это нужно, чтобы гитлаб позволял делать вебхуки на локалхост - по дефолту это отключено из соображений безопастности.



3) Идем в настройки нашего репозитория, чтобы настроить вебхук:

Settings → Integrations 

и создаем вебхук на адрес типа такого: http://EPRUPETW6168:8090/files

где имя хоста нужно заменить на свое.

Галочку нужно оставить только на Push Events.



4) Запускаем Камунду (желательно на 8080 порту, чтобы не менять настройки)



5) Запускаем mp-sys-bpm-config (метод main() из класса Application, предварительно прописав uri репозитория и креды в пропертях.

Кстати, конфиг-сервер будет клонировать репозиторий локально в специально заданную папку. За это отвечает spring.cloud.config.server.git.basedir.



6) Запускаем mp-sys-bpm-manager также через main-метод.

У этого модуля есть контроллер, замапленный на POST /files, который будет дергаться вебхуком.

Соответственно, задача этого модуля - получить из вебхука имена файлов, запросить их у конфиг-сервера, после чего задеплоить их в камунду.



7) Если все поднялось, то можно закоммитить любой файл в репозиторий, и он автоматически задеплоится в камунду.